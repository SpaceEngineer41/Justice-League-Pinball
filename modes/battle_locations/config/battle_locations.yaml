#config_version=6

mode:
  start_events: ball_starting
  priority: 700
  stop_events: battle_all_locations_completed

# -----------------------------------------------------------------------------
# PLAYER VARIABLES
# -----------------------------------------------------------------------------
variable_player:
  mode_battle_locations_started:
    battle_location_index:
      action: set
      int: 0
    battle_sequences_made:
      action: set
      int: 0
    battle_bank_ready:
      action: set
      int: 0

    # Themyscira tracking
    themyscira_drops_made:
      action: set
      int: 0

    # Atlantis tracking
    atlantis_bank_total_hits:
      action: set
      int: 0
    atlantis_steppenwolf_hits:
      action: set
      int: 0

  battle_advance_location:
    battle_location_index:
      action: add
      int: 1
    battle_sequences_made:
      action: set
      int: 0
    battle_bank_ready:
      action: set
      int: 0

    themyscira_drops_made:
      action: set
      int: 0

    atlantis_bank_total_hits:
      action: set
      int: 0
    atlantis_steppenwolf_hits:
      action: set
      int: 0

  battle_set_bank_ready:
    battle_bank_ready:
      action: set
      int: 1

  battle_clear_bank_ready:
    battle_bank_ready:
      action: set
      int: 0

  battle_inc_sequences:
    battle_sequences_made:
      action: add
      int: 1

  # --- Themyscira: increment per main drop down ---
  battle_themyscira_inc_drops:
    themyscira_drops_made:
      action: add
      int: 1

  # --- Atlantis: increment per bank shot hit (the 3 “main drop” shots) ---
  battle_atlantis_inc_bank_hit:
    atlantis_bank_total_hits:
      action: add
      int: 1

  # --- Atlantis: count steppenwolf completions inside Atlantis (1st = mid, 2nd = complete) ---
  battle_atlantis_inc_steppenwolf:
    atlantis_steppenwolf_hits:
      action: add
      int: 1

  # Optional scoring for drops
  drop_target_drop_main_left_down:
    score: 10000
  drop_target_drop_main_middle_down:
    score: 10000
  drop_target_drop_main_right_down:
    score: 10000

  # Optional scoring for Steppenwolf sequence completion
  battle_steppenwolf_made:
    score: 250000

# -----------------------------------------------------------------------------
# EVENTS
# -----------------------------------------------------------------------------
event_player:

  # --- MODE START ---
  mode_battle_locations_started:
    battle_start_current_location:
      delay: 1ms

  # ---------------------------------------------------------------------------
  # THEMYSCIRA (index 0): PLAY x1/x2/x3 ON INDIVIDUAL DROP TARGETS
  # ---------------------------------------------------------------------------
  drop_target_drop_main_left_down{current_player.battle_location_index==0}:
    - battle_themyscira_inc_drops
    - battle_themyscira_play_drop_video

  drop_target_drop_main_middle_down{current_player.battle_location_index==0}:
    - battle_themyscira_inc_drops
    - battle_themyscira_play_drop_video

  drop_target_drop_main_right_down{current_player.battle_location_index==0}:
    - battle_themyscira_inc_drops
    - battle_themyscira_play_drop_video

  battle_themyscira_play_drop_video{current_player.themyscira_drops_made==1}: battle_themyscira_x1
  battle_themyscira_play_drop_video{current_player.themyscira_drops_made==2}: battle_themyscira_x2
  battle_themyscira_play_drop_video{current_player.themyscira_drops_made==3}: battle_themyscira_x3

  # ---------------------------------------------------------------------------
  # ATLANTIS (index 1):
  #  - 1st set of 3 bank target hits => atlantis_x1, x2, x3
  #  - Steppenwolf (armed) hit #1     => atlantis_steppenwolf_x1 + reset center bank
  #  - 2nd set of 3 bank target hits => atlantis_x4, x5, x6
  #  - Steppenwolf (armed) hit #2     => atlantis_complete + mode completes (sequences==2)
  #
  # Uses YOUR real events shown in the log for those three shots:
  #   shot_main_drop_left_hit / shot_main_drop_middle_hit / shot_main_drop_right_hit
  # ---------------------------------------------------------------------------

  # Bank target hits (these count toward x1-x6)
  shot_main_drop_left_hit{current_player.battle_location_index==1}:
    - battle_atlantis_inc_bank_hit
    - battle_atlantis_play_bank_video

  shot_main_drop_middle_hit{current_player.battle_location_index==1}:
    - battle_atlantis_inc_bank_hit
    - battle_atlantis_play_bank_video

  shot_main_drop_right_hit{current_player.battle_location_index==1}:
    - battle_atlantis_inc_bank_hit
    - battle_atlantis_play_bank_video

  # Route x1-x6 based on total bank hits in Atlantis
  battle_atlantis_play_bank_video{current_player.atlantis_bank_total_hits==1}: battle_atlantis_x1
  battle_atlantis_play_bank_video{current_player.atlantis_bank_total_hits==2}: battle_atlantis_x2
  battle_atlantis_play_bank_video{current_player.atlantis_bank_total_hits==3}: battle_atlantis_x3
  battle_atlantis_play_bank_video{current_player.atlantis_bank_total_hits==4}: battle_atlantis_x4
  battle_atlantis_play_bank_video{current_player.atlantis_bank_total_hits==5}: battle_atlantis_x5
  battle_atlantis_play_bank_video{current_player.atlantis_bank_total_hits==6}: battle_atlantis_x6

  # --- BANK READY LOGIC (CENTER BANK that arms Steppenwolf) ---
  drop_target_bank_center_bank_down{device.drop_target_banks.center_bank.complete}:
    battle_set_bank_ready: {}

  drop_target_bank_center_bank_mixed:
    battle_clear_bank_ready: {}

  # ---------------------------------------------------------------------------
  # STEPPENWOLF HIT -> SEQUENCE PROGRESSION
  #
  # Themyscira: require bank_ready AND themyscira_drops_made>=3
  # Atlantis:
  #   - 1st Steppenwolf only when bank_ready AND bank_total_hits>=3 AND steppenwolf_hits==0
  #   - 2nd Steppenwolf only when bank_ready AND bank_total_hits>=6 AND steppenwolf_hits==1
  # Other locations: require bank_ready
  # ---------------------------------------------------------------------------

  # Themyscira gate
  shot_steppenwolf_hit{current_player.battle_location_index==0 and current_player.battle_bank_ready==1 and current_player.themyscira_drops_made>=3}:
    battle_steppenwolf_made: {}

  # Atlantis: FIRST Steppenwolf (armed) -> plays atlantis_steppenwolf_x1, resets center bank
  shot_steppenwolf_hit{current_player.battle_location_index==1 and current_player.battle_bank_ready==1 and current_player.atlantis_bank_total_hits>=3 and current_player.atlantis_steppenwolf_hits==0}:
    - battle_atlantis_steppenwolf_x1
    - battle_atlantis_inc_steppenwolf
    - battle_clear_bank_ready
    - drop_target_bank_center_bank_reset
    - battle_steppenwolf_made

  # Atlantis: SECOND Steppenwolf (armed) -> plays atlantis_complete and completes location (sequences hits 2)
  shot_steppenwolf_hit{current_player.battle_location_index==1 and current_player.battle_bank_ready==1 and current_player.atlantis_bank_total_hits>=6 and current_player.atlantis_steppenwolf_hits==1}:
    - battle_atlantis_complete
    - battle_atlantis_inc_steppenwolf
    - battle_steppenwolf_made

  # Other locations (exclude 0 and 1)
  shot_steppenwolf_hit{current_player.battle_location_index!=0 and current_player.battle_location_index!=1 and current_player.battle_bank_ready==1}:
    battle_steppenwolf_made: {}

  # On ANY Steppenwolf made:
  # - clear ready so you can't spam
  # - increment sequences
  # - check completion for current location
  # - for Themyscira, also play the completion video event
  battle_steppenwolf_made:
    - battle_clear_bank_ready
    - battle_inc_sequences
    - battle_check_location_complete
    - battle_themyscira_complete{current_player.battle_location_index==0 and current_player.themyscira_drops_made>=3}

  # --- SUBWAY CONFIRM / SAFE RESET + KICKOUT ---
  balldevice_bd_mystery_scoop_ball_enter:
    drop_target_bank_center_bank_reset:
      delay: 300ms
    eject_bd_mystery_scoop:
      delay: 600ms

  # --- START CURRENT LOCATION (BLINK) ---
  battle_start_current_location{current_player.battle_location_index==0}: battle_start_themyscira
  battle_start_current_location{current_player.battle_location_index==1}: battle_start_atlantis
  battle_start_current_location{current_player.battle_location_index==2}: battle_start_gotham
  battle_start_current_location{current_player.battle_location_index==3}: battle_start_metropolis
  battle_start_current_location{current_player.battle_location_index==4}: battle_start_pozharnov
  battle_start_current_location{current_player.battle_location_index==5}: battle_start_darkseid

  # --- COMPLETION THRESHOLDS ---
  battle_check_location_complete{current_player.battle_location_index==0 and current_player.battle_sequences_made>=1}: battle_location_completed
  battle_check_location_complete{current_player.battle_location_index==1 and current_player.battle_sequences_made>=2}: battle_location_completed
  battle_check_location_complete{current_player.battle_location_index==2 and current_player.battle_sequences_made>=3}: battle_location_completed
  battle_check_location_complete{current_player.battle_location_index==3 and current_player.battle_sequences_made>=4}: battle_location_completed
  battle_check_location_complete{current_player.battle_location_index==4 and current_player.battle_sequences_made>=5}: battle_location_completed
  battle_check_location_complete{current_player.battle_location_index==5 and current_player.battle_sequences_made>=6}: battle_location_completed

  # --- ON LOCATION COMPLETE: SOLID IT, ADVANCE, START NEXT BLINK ---
  battle_location_completed:
    - battle_lights_location_completed
    - battle_advance_location
    - battle_start_current_location

  # Solid the one we just completed (based on current index BEFORE it advances)
  battle_lights_location_completed{current_player.battle_location_index==0}: battle_location_completed_themyscira
  battle_lights_location_completed{current_player.battle_location_index==1}: battle_location_completed_atlantis
  battle_lights_location_completed{current_player.battle_location_index==2}: battle_location_completed_gotham
  battle_lights_location_completed{current_player.battle_location_index==3}: battle_location_completed_metropolis
  battle_lights_location_completed{current_player.battle_location_index==4}: battle_location_completed_pozharnov
  battle_lights_location_completed{current_player.battle_location_index==5}: battle_location_completed_darkseid

  battle_location_completed_darkseid: battle_all_locations_completed

# -----------------------------------------------------------------------------
# VIDEO PLAYBACK (slides)
# -----------------------------------------------------------------------------
slide_player:
  # Themyscira
  battle_themyscira_x1:
    themyscira_x1:
      priority: 900
  battle_themyscira_x2:
    themyscira_x2:
      priority: 900
  battle_themyscira_x3:
    themyscira_x3:
      priority: 900
  battle_themyscira_complete:
    themyscira_complete:
      priority: 950

  # Atlantis bank hit clips (x1-x6)
  battle_atlantis_x1:
    atlantis_x1:
      priority: 900
  battle_atlantis_x2:
    atlantis_x2:
      priority: 900
  battle_atlantis_x3:
    atlantis_x3:
      priority: 900
  battle_atlantis_x4:
    atlantis_x5:
      priority: 900
  battle_atlantis_x5:
    atlantis_x6:
      priority: 900
  battle_atlantis_x6:
    atlantis_x7:
      priority: 900

  # Atlantis Steppenwolf clips
  battle_atlantis_steppenwolf_x1:
    atlantis_steppenwolf_x1:
      priority: 950

  battle_atlantis_complete:
    atlantis_complete:
      priority: 980

# -----------------------------------------------------------------------------
# SHOWS
# -----------------------------------------------------------------------------
show_player:
  # Blink current location
  battle_start_themyscira:
    blink_themyscira:
      key: battle_location_blink
      loops: -1
      priority: 3000

  battle_start_atlantis:
    blink_atlantis:
      key: battle_location_blink
      loops: -1
      priority: 3000

  battle_start_gotham:
    blink_gotham:
      key: battle_location_blink
      loops: -1
      priority: 3000

  battle_start_metropolis:
    blink_metropolis:
      key: battle_location_blink
      loops: -1
      priority: 3000

  battle_start_pozharnov:
    blink_pozharnov:
      key: battle_location_blink
      loops: -1
      priority: 3000

  battle_start_darkseid:
    blink_darkseid:
      key: battle_location_blink
      loops: -1
      priority: 3000

  # Solid completed locations
  battle_location_completed_themyscira:
    solid_themyscira:
      key: battle_location_themyscira
      loops: -1
      priority: 2500

  battle_location_completed_atlantis:
    solid_atlantis:
      key: battle_location_atlantis
      loops: -1
      priority: 2500

  battle_location_completed_gotham:
    solid_gotham:
      key: battle_location_gotham
      loops: -1
      priority: 2500

  battle_location_completed_metropolis:
    solid_metropolis:
      key: battle_location_metropolis
      loops: -1
      priority: 2500

  battle_location_completed_pozharnov:
    solid_pozharnov:
      key: battle_location_pozharnov
      loops: -1
      priority: 2500

  battle_location_completed_darkseid:
    solid_darkseid:
      key: battle_location_darkseid
      loops: -1
      priority: 2500

# -----------------------------------------------------------------------------
# TIMERS
# -----------------------------------------------------------------------------
timers:
  steppenwolf_to_scoop_guard:
    start_value: 1
    end_value: 0
    direction: down
    tick_interval: 1s
    control_events:
      - event: shot_steppenwolf_hit
        action: start
      - event: balldevice_bd_mystery_scoop_ball_enter
        action: stop
